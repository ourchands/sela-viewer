name: بناء Sela Viewer

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    steps:
      - name: تحميل المستودع
        uses: actions/checkout@v4
        
      - name: تثبيت المتطلبات الأساسية
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake git python3 wget curl
          
      - name: تثبيت مكتبات التطوير
        run: |
          sudo apt-get install -y libgl1-mesa-dev libglu1-mesa-dev libx11-dev
          sudo apt-get install -y libxinerama-dev libxrandr-dev libxi-dev
          sudo apt-get install -y libfreetype6-dev libboost-all-dev libssl-dev
          
      - name: تثبيت مكتبات العربية
        run: |
          sudo apt-get install -y libharfbuzz-dev libfribidi-dev libicu-dev
          
      - name: استنساخ Firestorm
        run: |
          git clone --depth 1 https://github.com/FirestormViewer/phoenix-firestorm.git firestorm
          
      - name: نسخ ملفات العربية
        run: |
          mkdir -p firestorm/indra/llui
          cp llarabicsupport.h firestorm/indra/llui/ || true
          cp llarabicsupport.cpp firestorm/indra/llui/ || true
          mkdir -p firestorm/indra/cmake
          cp Arabic.cmake firestorm/indra/cmake/ || true
          
      - name: تحميل الخط العربي
        run: |
          mkdir -p firestorm/indra/newview/skins/default/fonts
          wget -O firestorm/indra/newview/skins/default/fonts/NotoSansArabic-Regular.ttf https://github.com/googlefonts/noto-fonts/raw/main/hinted/ttf/NotoSansArabic/NotoSansArabic-Regular.ttf
          
      - name: تعديل CMakeLists
        run: |
          cd firestorm
          if [ -f "indra/llui/CMakeLists.txt" ]; then
            sed -i '1i include(Arabic)' indra/llui/CMakeLists.txt
            sed -i '/set(llui_SOURCE_FILES/a \    llarabicsupport.cpp' indra/llui/CMakeLists.txt
          fi
          
      - name: تثبيت Autobuild
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install autobuild llbase
          
      - name: تهيئة البناء
        run: |
          cd firestorm
          autobuild configure -c ReleaseOS -DSTANDALONE:BOOL=ON
          
      - name: البناء
        run: |
          cd firestorm
          autobuild build -c ReleaseOS -- -j2
          
      - name: رفع النتيجة
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: Sela-Viewer-Linux
          path: firestorm/build-linux-x86_64/newview/packaged/
          retention-days: 30
