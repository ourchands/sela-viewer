name: بناء Sela Viewer

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-2022
    timeout-minutes: 360
    
    steps:
      - name: تحميل المستودع
        uses: actions/checkout@v4
        
      - name: إعداد Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: تثبيت Autobuild
        run: |
          pip install --user autobuild
          echo "$env:USERPROFILE\.local\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          
      - name: استنساخ Firestorm
        run: |
          git clone --depth 1 https://github.com/FirestormViewer/phoenix-firestorm.git firestorm
          
      - name: تحميل ملف المتغيرات
        run: |
          git clone --depth 1 https://github.com/FirestormViewer/fs-build-variables.git build-variables
          echo "AUTOBUILD_VARIABLES_FILE=$pwd\build-variables\variables" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          
      - name: نسخ ملفات العربية
        run: |
          New-Item -ItemType Directory -Force -Path firestorm\indra\llui
          Copy-Item llarabicsupport.h firestorm\indra\llui\ -ErrorAction SilentlyContinue
          Copy-Item llarabicsupport.cpp firestorm\indra\llui\ -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Force -Path firestorm\indra\cmake
          Copy-Item Arabic.cmake firestorm\indra\cmake\ -ErrorAction SilentlyContinue
          
      - name: تحميل الخط العربي
        run: |
          New-Item -ItemType Directory -Force -Path firestorm\indra\newview\skins\default\fonts
          Invoke-WebRequest -Uri "https://github.com/googlefonts/noto-fonts/raw/main/hinted/ttf/NotoSansArabic/NotoSansArabic-Regular.ttf" -OutFile firestorm\indra\newview\skins\default\fonts\NotoSansArabic-Regular.ttf
          
      - name: تعديل CMakeLists
        run: |
          cd firestorm
          if (Test-Path "indra\llui\CMakeLists.txt") {
            $content = Get-Content "indra\llui\CMakeLists.txt"
            if ($content -notmatch "include\(Arabic\)") {
              $content = "include(Arabic)`n" + $content
              Set-Content "indra\llui\CMakeLists.txt" $content
            }
            if ($content -notmatch "llarabicsupport.cpp") {
              $content = $content -replace '(set\(llui_SOURCE_FILES)', "`$1`n    llarabicsupport.cpp"
              Set-Content "indra\llui\CMakeLists.txt" $content
            }
          }
          
      - name: التهيئة والبناء
        run: |
          cd firestorm
          autobuild build -A 64 -c ReleaseFS_open
          
      - name: رفع البرنامج الجاهز
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: Sela-Viewer-Windows-x64
          path: firestorm\build-vc*-64\newview\Release\
          retention-days: 30

  build-linux:
    runs-on: ubuntu-22.04
    timeout-minutes: 360
    
    steps:
      - name: تحميل المستودع
        uses: actions/checkout@v4
        
      - name: تحرير مساحة القرص
        run: |
          echo "المساحة قبل التنظيف:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          echo "المساحة بعد التنظيف:"
          df -h
        
      - name: إعداد Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: تثبيت المتطلبات الأساسية
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake git wget curl
          sudo apt-get install -y libgl1-mesa-dev libglu1-mesa-dev libx11-dev
          sudo apt-get install -y libxinerama-dev libxrandr-dev libxi-dev
          sudo apt-get install -y libharfbuzz-dev libfribidi-dev libicu-dev
          sudo apt-get install -y libfreetype6-dev libboost-all-dev libssl-dev
          sudo apt-get install -y libpulse-dev libasound2-dev
          sudo apt-get clean
          
      - name: تثبيت Autobuild
        run: |
          pip3 install --user autobuild
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          
      - name: استنساخ Firestorm
        run: |
          git clone --depth 1 https://github.com/FirestormViewer/phoenix-firestorm.git firestorm
          
      - name: تحميل ملف المتغيرات
        run: |
          git clone --depth 1 https://github.com/FirestormViewer/fs-build-variables.git build-variables
          echo "AUTOBUILD_VARIABLES_FILE=$(pwd)/build-variables/variables" >> $GITHUB_ENV
          
      - name: نسخ ملفات العربية
        run: |
          mkdir -p firestorm/indra/llui
          cp llarabicsupport.h firestorm/indra/llui/ 2>/dev/null || echo "⚠ llarabicsupport.h"
          cp llarabicsupport.cpp firestorm/indra/llui/ 2>/dev/null || echo "⚠ llarabicsupport.cpp"
          mkdir -p firestorm/indra/cmake
          cp Arabic.cmake firestorm/indra/cmake/ 2>/dev/null || echo "⚠ Arabic.cmake"
          
      - name: تحميل الخط العربي
        run: |
          mkdir -p firestorm/indra/newview/skins/default/fonts
          wget -q -O firestorm/indra/newview/skins/default/fonts/NotoSansArabic-Regular.ttf \
            https://github.com/googlefonts/noto-fonts/raw/main/hinted/ttf/NotoSansArabic/NotoSansArabic-Regular.ttf
          
      - name: تعديل CMakeLists
        run: |
          cd firestorm
          if [ -f "indra/llui/CMakeLists.txt" ]; then
            if ! grep -q "include(Arabic)" indra/llui/CMakeLists.txt; then
              sed -i '1i include(Arabic)' indra/llui/CMakeLists.txt
            fi
            if ! grep -q "llarabicsupport.cpp" indra/llui/CMakeLists.txt; then
              sed -i '/set(llui_SOURCE_FILES/a \    llarabicsupport.cpp' indra/llui/CMakeLists.txt
            fi
          fi
          
      - name: التهيئة والبناء
        run: |
          cd firestorm
          echo "المساحة قبل البناء:"
          df -h
          autobuild build -A 64 -c ReleaseFS_open
          echo "المساحة بعد البناء:"
          df -h
          
      - name: رفع البرنامج الجاهز
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: Sela-Viewer-Linux-x64
          path: firestorm/build-linux-x86_64/newview/packaged/
          retention-days: 30
